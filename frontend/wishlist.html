<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Wishlist page</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/style.css" />
  </head>

  <body>
    <header class="nav-shell">
      <div class="nav-top">
        <button
          id="menuToggle"
          class="menu-btn"
          aria-expanded="false"
          aria-controls="navLinks"
        >
          <span class="menu-icon"></span>
          <span class="menu-text">Menu</span>
        </button>

        <a href="index.html" class="brand">
          <img src="/Assets/Logo.png" alt="logo" style="height: 40px" />
        </a>

        <div class="navbar-buttons" id="navbarUser">
          <a
            class="button-primary"
            href="signUp.html"
            style="text-decoration: none; color: #fff"
            >Sign Up</a
          >
          <a
            class="button-primary"
            href="login.html"
            style="text-decoration: none; color: #fff"
            >Login</a
          >
        </div>
      </div>

      <div id="navLinks" class="nav-links">
        <nav id="navbar" class="navbar-selector">
          <a href="buy.html">Buy</a>
          <a href="rent.html">Rent</a>
          <a href="sold.html">Sold</a>
          <a href="findAgent.html">Find Agent</a>
          <a href="news.html">News</a>
        </nav>
      </div>
    </header>

    <div id="wishlist">
      <div class="optimization-text">
        <p class="optimization-h1">Your Wishlist</p>
        <p class="optimization-subheader">
          Here are all the properties you have wishlisted!
        </p>
      </div>

      <!-- Use same grid class as buy/rent -->
      <div class="wishlist-layout prop-grid"></div>
    </div>

    <script src="/js/wishlist.js"></script>

    <script>
      // ----- Navbar: show logged-in user + logout
      (function () {
        const navbarUser = document.getElementById("navbarUser");
        try {
          const user = JSON.parse(localStorage.getItem("user") || "null");
          if (!user) return;

          const displayName = (user.first_name || "").trim() || user.email;
          navbarUser.innerHTML = `
            <span style="margin-right:10px; color:#047857; font-weight:600;">
              Welcome, ${escapeHtml(displayName)}
            </span>
            <button class="button-secondary" id="logoutBtn">Logout</button>
          `;
          document.getElementById("logoutBtn").addEventListener("click", () => {
            localStorage.removeItem("user");
            location.reload();
          });
        } catch {}
      })();

      // ----- Highlight active nav link + burger
      (function () {
        const shell = document.querySelector(".nav-shell");
        const btn = document.getElementById("menuToggle");
        if (btn && shell) {
          btn.addEventListener("click", () => {
            const isOpen = shell.classList.toggle("open");
            btn.setAttribute("aria-expanded", String(isOpen));
          });
        }

        const path = location.pathname.replace(/\/+$/, "");
        document.querySelectorAll("#navbar a[href]").forEach((a) => {
          const href = a.getAttribute("href") || "";
          const isHome =
            (path === "" || path === "/") &&
            (href === "index.html" || href === "/index.html");
          if (
            isHome ||
            path.endsWith(href) ||
            (href.startsWith("/") && path === href)
          ) {
            a.classList.add("nav-active");
          }
        });
      })();

      // ----- Reuse the same nav/auth script from index.html (like other pages)
      (function () {
        const shell = document.querySelector(".nav-shell");
        const btn = document.getElementById("menuToggle");
        if (btn && shell) {
          btn.addEventListener("click", () => {
            const isOpen = shell.classList.toggle("open");
            btn.setAttribute("aria-expanded", String(isOpen));
          });
        }

        const path = location.pathname.replace(/\/+$/, "");
        document.querySelectorAll("#navbar a[href]").forEach((a) => {
          const href = a.getAttribute("href") || "";
          const isHome =
            (path === "" || path === "/") &&
            (href === "index.html" || href === "/index.html");
          if (
            isHome ||
            path.endsWith(href) ||
            (href.startsWith("/") && path === href)
          ) {
            a.classList.add("nav-active");
          }
        });
      })();

      (function () {
        const wrap = document.querySelector(".wishlist-layout");

        function money(n) {
          if (typeof n !== "number") return "";
          return n.toLocaleString("en-AU", {
            style: "currency",
            currency: "AUD",
            maximumFractionDigits: 0,
          });
        }

        function card(p) {
          const base = money(Number(p.price || 0));
          const priceLabel =
            String(p.status).toLowerCase() === "rent" ? base + " / wk" : base;
          const cover =
            p.image || (p.images && p.images[0]) || "/Assets/placeholder.png";
          const payload = encodeURIComponent(JSON.stringify(p));
          const filled = inWishlist(p); // from wishlist.js

          return `
    <article class="property-card">
      <div class="prop-photo-wrap"
           onclick="location.href='property.html?id=${
             p.id
           }&status=${encodeURIComponent(p.status || "")}'"
           style="cursor:pointer">
        <img class="prop-photo" src="${cover}" alt="${escapeHtml(
            p.address || ""
          )}">
        <span class="prop-badge">${escapeHtml(p.type || "Property")}</span>
      </div>
      <div class="prop-body">
        <div class="prop-price">${priceLabel}</div>
        <div class="prop-address">${escapeHtml(p.address || "")}</div>
        <div class="prop-sub">${escapeHtml(p.suburb || "")}, ${escapeHtml(
            p.state || ""
          )} ${escapeHtml(p.postcode || "")}</div>
        <div class="prop-meta">
          <span>üõè ${p.bedrooms ?? 0}</span>
          <span>üõÅ ${p.bathrooms ?? 0}</span>
          <span>üöó ${p.carspaces ?? 0}</span>
        </div>

        <div class="prop-actions" style="display:flex; gap:8px; align-items:center;">
          <button class="btn-primary-full">Enquire</button>
          <a class="btn-primary-full"
             href="bookInspection.html?propertyId=${
               p.id
             }&address=${encodeURIComponent(
            p.address || ""
          )}&price=${encodeURIComponent(p.price || "")}">
             Book inspection
          </a>
          <img
            class="love-icon"
            data-listing="${payload}"
            src="${
              filled ? "/Assets/ri_heart-fill.png" : "/Assets/love-icon.png"
            }"
            alt="Save"
            style="margin-left:auto; width:24px; height:24px; cursor:pointer"
          />
        </div>
      </div>
    </article>
  `;
        }

        function renderWishlist() {
          const items = getWishlist(); // from wishlist.js

          if (!items.length) {
            wrap.innerHTML = '<p class="helper">No saved properties yet.</p>';
            return;
          }

          wrap.innerHTML = items.map(card).join("");

          // Ensure hearts reflect saved state
          wrap.querySelectorAll(".love-icon").forEach((el) => {
            try {
              const l = JSON.parse(
                decodeURIComponent(el.dataset.listing || "{}")
              );
              setHeart(el, inWishlist(l)); // from wishlist.js
            } catch {
              setHeart(el, false);
            }
          });
        }

        // Toggle wishlist on heart click (remove card if un-saved)
        function onClick(e) {
          const el = e.target.closest(".love-icon");
          if (!el) return;

          let listing;
          try {
            listing = JSON.parse(
              decodeURIComponent(el.dataset.listing || "{}")
            );
          } catch {
            listing = {};
          }

          const { added } = toggleWishlist(listing); // from wishlist.js
          setHeart(el, added);

          if (!added) {
            el.closest(".property-card")?.remove();
            if (!getWishlist().length) {
              wrap.innerHTML = '<p class="helper">No saved properties yet.</p>';
            }
          }
        }

        // Cross-tab sync
        function onStorage(evt) {
          if (!evt.key || !evt.key.startsWith("wishlist:")) return;
          wrap.querySelectorAll(".love-icon").forEach((el) => {
            try {
              const l = JSON.parse(
                decodeURIComponent(el.dataset.listing || "{}")
              );
              setHeart(el, inWishlist(l));
            } catch {
              setHeart(el, false);
            }
          });
        }

        wrap.addEventListener("click", onClick);
        window.addEventListener("storage", onStorage);

        renderWishlist();
      })();

      function escapeHtml(str = "") {
        return String(str).replace(
          /[&<>"']/g,
          (s) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[s])
        );
      }
    </script>
  </body>

  <footer class="site-footer">
    <div class="footer-inner">
      <div class="footer-cols">
        <div class="footer-col footer-brand">
          <div class="brand">
            <img src="/Assets/Logo.png" alt="MyHome logo" class="footer-logo" />
          </div>
        </div>

        <div class="footer-col">
          <h4 class="footer-title">Product</h4>
          <a href="#">How it works</a>
          <a href="#">Who we help</a>
          <a href="#">Features</a>
          <a href="#">Pricing</a>
        </div>

        <div class="footer-col">
          <h4 class="footer-title">Resources</h4>
          <a href="#">Get Help</a>
          <a href="#">Partnership</a>
          <a href="#">Blog</a>
          <a href="#">Legal</a>
        </div>

        <div class="footer-col">
          <h4 class="footer-title">About</h4>
          <a href="#">About</a>
          <a href="#">Sponsorship</a>
          <a href="#">Hardship</a>
          <a href="#">Contact</a>
        </div>

        <div class="footer-col footer-connect">
          <h4 class="footer-title">Connect with us</h4>
          <div class="footer-socials">
            <a href="#" aria-label="Facebook" class="icon">
              <svg
                viewBox="0 0 24 24"
                width="18"
                height="18"
                aria-hidden="true"
              >
                <image
                  href="/Assets/facebook.png"
                  xlink:href="/Assets/facebook-app-symbol.png"
                  width="18"
                  height="18"
                />
              </svg>
            </a>

            <a href="#" aria-label="YouTube" class="icon">
              <svg
                viewBox="0 0 24 24"
                width="18"
                height="18"
                aria-hidden="true"
              >
                <image
                  href="/Assets/youtube.png"
                  xlink:href="/Assets/youtube.png"
                  width="18"
                  height="18"
                />
              </svg>
            </a>
            <a href="#" aria-label="Twitter" class="icon">
              <svg
                viewBox="0 0 24 24"
                width="18"
                height="18"
                aria-hidden="true"
              >
                <image
                  href="/Assets/twitter.png"
                  xlink:href="/Assets/twitter.png"
                  width="18"
                  height="18"
                />
              </svg>
            </a>
          </div>
        </div>
      </div>

      <hr class="footer-divider" />
      <div class="footer-bottom">
        <div>Copyright 2025 ¬∑ MyHome</div>
        <div class="footer-legal">
          <a href="#">Terms of Service</a>
          <a href="#">Privacy Policy</a>
        </div>
      </div>
    </div>
  </footer>
</html>
