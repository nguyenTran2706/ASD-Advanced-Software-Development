<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Buy Results Â· MyHome</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <header class="nav-shell">
      <div class="nav-top">
        <button
          id="menuToggle"
          class="menu-btn"
          aria-expanded="false"
          aria-controls="navLinks"
        >
          <span class="menu-icon"></span>
          <span class="menu-text">Menu</span>
        </button>

        <a href="index.html" class="brand">
          <img src="/Assets/Logo.png" alt="logo" style="height: 40px" />
        </a>

        <div class="navbar-buttons" id="navbarUser">
          <a
            class="button-primary"
            href="signUp.html"
            style="text-decoration: none; color: #fff"
            >Sign Up</a
          >
          <a
            class="button-primary"
            href="login.html"
            style="text-decoration: none; color: #fff"
            >Login</a
          >
        </div>
      </div>

      <div id="navLinks" class="nav-links">
        <nav id="navbar" class="navbar-selector">
          <a href="buy.html">Buy</a>
          <a href="rent.html">Rent</a>
          <a href="sold.html">Sold</a>
          <a href="findAgent.html">Find Agent</a>
          <a href="news.html">News</a>
        </nav>
      </div>
    </header>

    <section class="prop-hero">
      <div class="prop-hero-inner">
        <div class="prop-search">
          <div id="chips" class="prop-chips"></div>
        </div>
        <div>
          <button id="editFilters" class="button-secondary">
            Edit filters
          </button>
        </div>
      </div>
    </section>

    <main style="padding: 24px 32px">
      <div id="listingContainer" class="container-layout"></div>
    </main>

    <div id="filterModal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <span id="closeFilter" class="close" aria-label="Close">&times;</span>
        <h2>Filter Listings</h2>

        <div class="filter-group">
          <label for="typeFilter">Type</label>
          <select id="typeFilter">
            <option value="">Any</option>
            <option value="house">House</option>
            <option value="apartment">Apartment</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="bedFilter">Beds</label>
          <select id="bedFilter">
            <option value="">Any</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4+">4+</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="priceFilter">Price</label>
          <select id="priceFilter">
            <!-- buy page uses SOLD/BUY buckets -->
            <option value="">Any</option>
            <option value="0-600k">0-600k</option>
            <option value="600k-900k">600k-900k</option>
            <option value="900k-1.5M">900k-1.5M</option>
            <option value="1.5M+">1.5M+</option>
          </select>
        </div>

        <div
          style="
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
          "
        >
          <button class="button-secondary" id="resetFilter">Reset</button>
          <button class="button-primary" id="applyFilter">Apply</button>
        </div>
      </div>
    </div>

    <script src="/js/wishlist.js"></script>

    <script>
      function escapeHtml(str = "") {
        return String(str).replace(
          /[&<>"']/g,
          (s) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[s])
        );
      }

      (async function () {
        try {
          const res = await fetch("index.html");
          const html = await res.text();
          const doc = new DOMParser().parseFromString(html, "text/html");
          const navShell = doc.querySelector(".nav-shell");
          // Find the nav bar's inline script in index.html
          const navScriptText = Array.from(
            doc.querySelectorAll("script:not([src])")
          ).find((s) =>
            s.innerText.includes("// -------- Auth area")
          )?.innerText;

          document.querySelector(".nav-shell").replaceWith(navShell);
          if (navScriptText) {
            eval(navScriptText); // Re-run the auth/nav script
          }
        } catch (e) {
          console.error("Could not load navigation bar.", e);
        }
      })();

      const params = new URLSearchParams(location.search);
      const q = params.get("q") || "";
      const status = (params.get("status") || "buy").toLowerCase();
      const type = params.get("type") || "";
      const beds = params.get("beds") || "";
      const price = params.get("price") || "";

      function renderChips() {
        const c = document.getElementById("chips");
        if (!c) return;
        const chips = [
          `<span class="chip active">Status: ${escapeHtml(status)}</span>`,
        ];
        if (q) chips.push(`<span class="chip">Query: ${escapeHtml(q)}</span>`);
        if (type)
          chips.push(`<span class="chip">Type: ${escapeHtml(type)}</span>`);
        if (beds)
          chips.push(`<span class="chip">Beds: ${escapeHtml(beds)}</span>`);
        if (price)
          chips.push(`<span class="chip">Price: ${escapeHtml(price)}</span>`);
        c.innerHTML = chips.join(" ");
      }

      // ---- prefill modal
      function prefillModal() {
        const t = document.getElementById("typeFilter");
        if (t) t.value = type;
        const b = document.getElementById("bedFilter");
        if (b) b.value = beds;
        const p = document.getElementById("priceFilter");
        if (p) p.value = price;
      }

      function buildUrlWith(newVals = {}) {
        const u = new URL(location.href);
        const sp = u.searchParams;

        sp.set("status", "buy"); // always buy on this page
        q ? sp.set("q", q) : sp.delete("q");

        if ("type" in newVals)
          newVals.type ? sp.set("type", newVals.type) : sp.delete("type");
        if ("beds" in newVals)
          newVals.beds ? sp.set("beds", newVals.beds) : sp.delete("beds");
        if ("price" in newVals)
          newVals.price ? sp.set("price", newVals.price) : sp.delete("price");

        return u.toString();
      }

      function renderCard(l) {
        const cover =
          l.image || (l.images && l.images[0]) || "/Assets/placeholder.png";
        const statusTag =
          l.status === "rent"
            ? "For Rent"
            : l.status === "buy"
            ? "For Sale"
            : l.status || "";
        const payload = encodeURIComponent(JSON.stringify(l));
        const filled = inWishlist(l);

        return `
      <div class="container" data-id="${l.id ?? ""}">
        <div class="property-image">
          <div class="property-pill"><p>${escapeHtml(statusTag)}</p></div>
          <div class="property-details">
            <p>${escapeHtml(l.suburb || "")}, ${escapeHtml(l.state || "")}</p>
            <div class="property-details-icons">
              <div class="icon-text"><p>${escapeHtml(
                l.bedrooms ?? 0
              )}</p><img src="/Assets/bed.png" alt="bed" /></div>
              <div class="icon-text"><p>${escapeHtml(
                l.bathrooms ?? 0
              )}</p><img src="/Assets/shower.png" alt="bath" /></div>
              <div class="icon-text"><p>${escapeHtml(
                l.carspaces ?? 0
              )}</p><img src="/Assets/car.png" alt="car" /></div>
            </div>
          </div>
          <img src="${escapeHtml(cover)}" alt="property" />
        </div>
        <div class="love">
          <div class="text-love">
            <p>${escapeHtml(l.address || "")}</p>
            <div class="unit-tag">
              <img src="/Assets/dot-grey.png" alt="dot" />
              <p>${escapeHtml(l.type || "")}</p>
            </div>
          </div>
          <img class="love-icon"
           data-listing="${payload}"
           src="${
             filled ? "/Assets/ri_heart-fill.png" : "/Assets/love-icon.png"
           }"
           alt="Love-icon" />
        </div>
      </div>
    `;
      }

      function priceBucketToRange(bucket) {
        switch ((bucket || "").toLowerCase()) {
          case "0-600k":
            return [0, 600000];
          case "600k-900k":
            return [600000, 900000];
          case "900k-1.5m":
            return [900000, 1500000];
          case "1.5m+":
            return [1500000, Infinity];
          default:
            return null;
        }
      }

      async function fetchListings() {
        const qs = new URLSearchParams();
        qs.set("status", "buy");
        if (q) qs.set("q", q);
        if (type) qs.set("type", type);
        if (beds) qs.set("minBeds", beds); // backend expects minBeds

        const url = "/api/listings?" + qs.toString();

        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error("fetch failed");
          const data = await res.json();
          let results = Array.isArray(data.results) ? data.results : [];

          if (price) {
            const range = priceBucketToRange(price);
            if (range) {
              const [min, max] = range;
              results = results.filter((r) => {
                const p = Number(r.price);
                return !isNaN(p) && p >= min && p < max;
              });
            }
          }

          return results;
        } catch (e) {
          console.error(e);
          return [];
        }
      }

      async function load() {
        renderChips();
        prefillModal();

        const container = document.getElementById("listingContainer");
        container.innerHTML = "<p>Loadingâ¦</p>";

        const results = await fetchListings();

        if (!results.length) {
          container.innerHTML = "<p>No properties found.</p>";
          return;
        }

        container.innerHTML = results.map(renderCard).join("");

        container.querySelectorAll(".love-icon").forEach((el) => {
          try {
            const listing = JSON.parse(
              decodeURIComponent(el.dataset.listing || "{}")
            );
            setHeart(el, inWishlist(listing));
          } catch {
            setHeart(el, false);
          }
        });
      }

      (function modalWiring() {
        const editBtn = document.getElementById("editFilters");
        const modal = document.getElementById("filterModal");
        const closeBtn = document.getElementById("closeFilter");
        const resetBtn = document.getElementById("resetFilter");
        const applyBtn = document.getElementById("applyFilter");

        editBtn.addEventListener("click", () => {
          prefillModal();
          modal.style.display = "flex";
          modal.setAttribute("aria-hidden", "false");
        });

        closeBtn.addEventListener("click", () => {
          modal.style.display = "none";
          modal.setAttribute("aria-hidden", "true");
        });
        window.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.style.display = "none";
            modal.setAttribute("aria-hidden", "true");
          }
        });

        resetBtn.addEventListener("click", () => {
          document.getElementById("typeFilter").value = "";
          document.getElementById("bedFilter").value = "";
          document.getElementById("priceFilter").value = "";
        });

        applyBtn.addEventListener("click", () => {
          const newVals = {
            type: document.getElementById("typeFilter").value,
            beds: document.getElementById("bedFilter").value,
            price: document.getElementById("priceFilter").value,
          };
          location.href = buildUrlWith(newVals);
        });
      })();

      (function setupWishlistListeners() {
        const container = document.getElementById("listingContainer");
        if (!container) return;

        container.addEventListener("click", (e) => {
          const el = e.target.closest(".love-icon");
          if (!el) return;

          let listing;
          try {
            listing = JSON.parse(
              decodeURIComponent(el.dataset.listing || "{}")
            );
          } catch {
            listing = {};
          }

          const { added } = toggleWishlist(listing);
          setHeart(el, added);
        });

        window.addEventListener("storage", (evt) => {
          if (!evt.key || !evt.key.startsWith("wishlist:")) return;
          container.querySelectorAll(".love-icon").forEach((el) => {
            try {
              const l = JSON.parse(
                decodeURIComponent(el.dataset.listing || "{}")
              );
              setHeart(el, inWishlist(l));
            } catch {
              setHeart(el, false);
            }
          });
        });
      })();

      load();
    </script>
  </body>
</html>
