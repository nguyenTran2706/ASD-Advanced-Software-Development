<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Property details</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>

<body>
  <!-- Header -->
  <header class="nav-shell">
    <div class="nav-top">
      <button
        id="menuToggle"
        class="menu-btn"
        aria-expanded="false"
        aria-controls="navLinks"
      >
        <span class="menu-icon"><span></span></span>
        <span class="menu-text">Menu</span>
      </button>

      <a href="index.html" class="brand">
        <img src="/Assets/Logo.png" alt="logo" style="height: 40px" />
      </a>

      <div class="navbar-buttons" id="navbarUser">
        <a
          class="button-primary"
          href="signUp.html"
          style="text-decoration: none; color: #fff"
          >Sign Up</a
        >
        <a
          class="button-primary"
          href="login.html"
          style="text-decoration: none; color: #fff"
          >Login</a
        >
      </div>
    </div>

    <div id="navLinks" class="nav-links">
      <nav id="navbar" class="navbar-selector">
        <a href="buy.html">Buy</a>
        <a href="rent.html">Rent</a>
        <a href="sold.html">Sold</a>
        <a href="findAgent.html">Find Agent</a>
        <a href="news.html">News</a>
      </nav>
    </div>
  </header>

  <section class="prop-detail-wrap">
    <div class="results-header">
      <div id="resultsPath" class="results-path">Property</div>
      <div class="filters-row">
        <a id="backBtn" class="chip" href="javascript:void(0)">‚Üê Back</a>
      </div>
    </div>

    <div id="errorBox" class="helper error" hidden></div>

    <div id="detail" class="prop-detail" aria-live="polite">
      <!-- filled by script -->
    </div>
  </section>

  <!-- Map and Directions Section -->
  <section id="news-map-wrap">
    <div class="optimization-text">
      <p class="optimization-h1">Explore on the map</p>
      <p class="optimization-subheader">Search any address and get directions</p>
    </div>

    <div class="map-controls">
      <input id="mapOrigin" class="map-input" type="text" placeholder="From (origin address)" />
      <input id="mapDestination" class="map-input" type="text" placeholder="To (destination address)" />
      <button id="mapLocateDest" class="button-secondary">Locate</button>
      <button id="mapDirections" class="button-primary">Open Directions</button>
    </div>

    <div id="news-map"></div>
    
    <!-- State Legend -->
    <div class="state-legend">
      <h4>State Legend</h4>
      <div class="legend-items">
        <div class="legend-item"><span class="legend-color" style="background-color: #dc2626;"></span>NSW</div>
        <div class="legend-item"><span class="legend-color" style="background-color: #2563eb;"></span>VIC</div>
        <div class="legend-item"><span class="legend-color" style="background-color: #059669;"></span>QLD</div>
        <div class="legend-item"><span class="legend-color" style="background-color: #7c3aed;"></span>WA</div>
        <div class="legend-item"><span class="legend-color" style="background-color: #ea580c;"></span>SA</div>
        <div class="legend-item"><span class="legend-color" style="background-color: #0891b2;"></span>ACT</div>
        <div class="legend-item"><span class="legend-color" style="background-color: #be123c;"></span>TAS</div>
        <div class="legend-item"><span class="legend-color" style="background-color: #ca8a04;"></span>NT</div>
      </div>
    </div>
    
    <div class="fine">Powered by OpenStreetMap ‚Ä¢ Nominatim geocoding</div>
  </section>

  <div class="site-footer-spacer"></div>

  <script src="/js/wishlist.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /* Logged-in banner */
    (function () {
      const el = document.getElementById('navbarUser'); try {
        const u = JSON.parse(localStorage.getItem('user') || 'null'); if (!u) return;
        const name = u.first_name?.trim() || u.email;
        el.innerHTML = `<span style="margin-right:10px;color:#047857;font-weight:600;">Welcome, ${name}</span>
        <button class="button-secondary" id="logoutBtn">Logout</button>`;
        document.getElementById('logoutBtn').onclick = () => { localStorage.removeItem('user'); location.reload(); };
      } catch (_) { }
    })();

    /* Active nav highlighting */
    (function () {
      try {
        const path = location.pathname.replace(/\/+$/, '');
        const navLinks = document.querySelectorAll('.navbar-selector a[href]');
        
        navLinks.forEach(a => {
          const href = a.getAttribute('href') || '';
          const isHome = (path === '' || path === '/' || path.endsWith('/')) && 
                         (href === 'index.html' || href === '/index.html' || href === '/');
          
          if (isHome || path.endsWith(href) || (href.startsWith('/') && path === href)) {
            a.classList.add('nav-active');
          }
        });
        
        console.log("Nav highlighting initialized");
      } catch (err) {
        console.error("Nav highlighting error:", err);
      }
    })();

    const qs = new URLSearchParams(location.search);
    const id = qs.get('id');
    const status = (qs.get('status') || '').toLowerCase();

    const resultsPath = document.getElementById('resultsPath');
    resultsPath.textContent =
      status === 'buy' ? 'For sale' :
        status === 'rent' ? 'For rent' :
          status === 'sold' ? 'Recently sold' : 'Property';

    // Back button
    document.getElementById('backBtn').onclick = () => {
      if (history.length > 1) history.back();
      else {
        const fallback = status === 'rent' ? 'rent.html' : status === 'sold' ? 'sold.html' : 'buy.html';
        location.href = fallback;
      }
    };

    function money(n) {
      if (typeof n !== 'number' || isNaN(n)) return '';
      return n.toLocaleString('en-AU', { style: 'currency', currency: 'AUD', maximumFractionDigits: 0 });
    }

    function priceLabel(p) {
      const n = Number(p.price);
      if (p.status === 'rent') return `${money(n)} / wk`;
      if (p.status === 'sold') return `Sold ${money(n)}`;
      return money(n);
    }

    function galleryHTML(p) {
      const imgs = (Array.isArray(p.images) && p.images.length ? p.images : []).filter(Boolean);
      const cover = p.image || p.cover || imgs[0] || '/Assets/placeholder.png';
      const all = [cover, ...imgs.filter(src => src !== cover)];
      const main = `<img id="mainImg" src="${all[0]}" alt="${p.address || 'Property photo'}">`;
      const thumbs = all.length > 1
        ? `<div class="thumb-row">` + all.map((src, i) =>
          `<img src="${src}" alt="photo ${i + 1}" onclick="document.getElementById('mainImg').src='${src}'">`
        ).join('') + `</div>`
        : '';
      return `<div class="prop-gallery">${main}${thumbs}</div>`;
    }

    function infoHTML(p) {
      const addr = [p.address || '', [p.suburb, p.state].filter(Boolean).join(', '), p.postcode || '']
        .join(' ').replace(/\s+/g, ' ').trim();
      return `
      <div class="prop-panel">
        <div class="pill">${p.type || 'Property'}</div>
        <h1 class="prop-title">${priceLabel(p)}</h1>
        <div class="prop-sub">${addr}</div>
        <div class="specs">
          <span>üõè <span class="value">${p.bedrooms ?? 0}</span></span>
          <span>üõÅ <span class="value">${p.bathrooms ?? 0}</span></span>
          <span>üöó <span class="value">${p.carspaces ?? 0}</span></span>
        </div>
        <div class="divider"></div>
        <div>
          <span class="label">Status</span>
          <div class="value" style="text-transform:capitalize">${p.status || status || ''}</div>
        </div>
        <div class="divider"></div>
        <div class="cta-row">
          <a class="btn-primary-full" href="/enquire.html?suburb=${encodeURIComponent(p.suburb || '')}">Enquire</a>
          <button class="btn-ghost-full" onclick="saveListing(${p.id})">Save</button>
        </div>
        <p class="muted">ID: ${p.id ?? ''}</p>
      </div>
    `;
    }

    function render(p) {
      document.getElementById('detail').innerHTML = `
    ${galleryHTML(p)}
    ${infoHTML(p)}

    <!-- ===== Property Meta (Highlights ‚Ä¢ Description ‚Ä¢ Features ‚Ä¢ Agent Card) ===== -->
    <section id="prop-highlights" class="card-section" hidden>
      <h3 class="card-title">Property highlights</h3>
      <ul id="prop-highlights-list" class="highlights"></ul>
    </section>

    <section id="prop-longdesc" class="card-section" hidden>
      <h3 class="visually-hidden">Description</h3>
      <div id="prop-longdesc-body" class="long-text clamp-6"></div>
      <button id="prop-longdesc-toggle" class="linklike" type="button">Read more</button>
    </section>

    <section id="prop-features" class="card-section" hidden>
      <h3 class="card-title">Property features</h3>
      <div id="prop-features-grid" class="features-grid"></div>
    </section>

    <aside id="prop-agent" class="card-section agent-card" hidden></aside>
    <!-- ===== /Property Meta ===== -->

  `;

      // update breadcrumb with property type/address
      const crumb = [];
      if (p.type) crumb.push(p.type);
      if (p.suburb) crumb.push(p.suburb);
      document.getElementById('resultsPath').textContent =
        crumb.length ? crumb.join(' ‚Ä¢ ') : document.getElementById('resultsPath').textContent;

      // NEW: build highlights/description/features/agent
      if (typeof renderPropertyMeta === 'function') {
        renderPropertyMeta(p);
      }

      // Load property on map
      if (typeof window.loadPropertyMap === 'function') {
        window.loadPropertyMap(p);
      }
    }


    function showError(msg) {
      const box = document.getElementById('errorBox');
      box.textContent = msg; box.hidden = false;
      document.getElementById('detail').innerHTML = '';
    }

    async function load() {
      if (!id) { showError('Missing property id.'); return; }
      try {
        const res = await fetch(`/api/listings/${encodeURIComponent(id)}`);
        const text = await res.text();
        let data = {}; try { data = JSON.parse(text); } catch { throw new Error(text || 'Failed to parse response'); }
        if (!res.ok) throw new Error(data.error || 'Unable to load property');
        data.status = (data.status || status || '').toLowerCase();
        render(data);
      } catch (err) {
        showError(err.message || 'Could not load property.');
      }
    }

    function saveListing(id) {
      try {
        const key = 'savedListings';
        const arr = JSON.parse(localStorage.getItem(key) || '[]');
        if (!arr.includes(id)) arr.push(id);
        localStorage.setItem(key, JSON.stringify(arr));
        alert('Saved!');
      } catch (_) { }
    }

    // Mobile menu toggle - Initialize FIRST
    (function () {
      const shell = document.querySelector(".nav-shell");
      const btn = document.getElementById("menuToggle");
      const navLinks = document.querySelectorAll(".navbar-selector a");
      
      if (!shell) {
        console.error("Nav shell not found");
        return;
      }
      
      if (!btn) {
        console.error("Menu toggle button not found");
        return;
      }
      
      // Toggle menu on button click
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        const isOpen = shell.classList.toggle("open");
        btn.setAttribute("aria-expanded", String(isOpen));
        console.log("Menu toggled:", isOpen ? "open" : "closed");
      });
      
      // Close menu when clicking a nav link (better UX on mobile)
      navLinks.forEach(link => {
        link.addEventListener("click", () => {
          if (shell.classList.contains("open")) {
            shell.classList.remove("open");
            btn.setAttribute("aria-expanded", "false");
            console.log("Menu closed via nav link");
          }
        });
      });
      
      // Close menu when clicking outside
      document.addEventListener("click", (e) => {
        if (shell.classList.contains("open") && 
            !shell.contains(e.target) && 
            e.target !== btn) {
          shell.classList.remove("open");
          btn.setAttribute("aria-expanded", "false");
          console.log("Menu closed via outside click");
        }
      });
      
      console.log("Mobile menu initialized successfully");
    })();

    load();
  </script>
  <script>
    /* ===== Property Meta (Highlights ‚Ä¢ Long Description ‚Ä¢ Features ‚Ä¢ Agent Card)
       Works even if there is NO manual meta. Exposes window.renderPropertyMeta(p)
       and expects the four containers already in your render(p) HTML:
       - #prop-highlights / #prop-highlights-list
       - #prop-longdesc / #prop-longdesc-body / #prop-longdesc-toggle
       - #prop-features / #prop-features-grid
       - #prop-agent
    */
    (function () {
      const $ = id => document.getElementById(id);
      const pick = arr => arr[Math.floor(Math.random() * arr.length)];
      const s = (...bits) => bits.filter(Boolean).join(' ').replace(/\s+/g, ' ').trim();

      // Optional hand-authored per-listing content. Add entries as you like.
      const MANUAL_META = {
        // 65: {
        //   highlights: ['Bright north-east aspect','Open-plan living & dining','Modern kitchen'],
        //   longDesc: `Positioned for convenience in the heart of Marrickville ...`,
        //   features: ['Built-in wardrobes','Ensuite: 1','Open car spaces: 1'],
        //   agent: 'ken'
        // }
      };

      // Your 3 agents (use any details you like here)
      const AGENTS = {
        ken: { name: 'Ken (Hiroyoshi) Miyagawa', agency: 'Richard Matthews Real Estate', phone: '04780178‚Ä¶', rating: '5.0 (18 reviews)', address: '183 The Boulevarde, STRATHFIELD, NSW 2135', badge: 'Get your property appraised' },
        adrian: { name: 'Adrian William', agency: 'Adrian William', phone: '02 9000 0000', rating: '5.0 (1093 reviews)', address: 'Canterbury', badge: 'Request a free appraisal' },
        denny: { name: 'Denny Barros', agency: 'Adrian William', phone: '02 8000 0000', rating: '5.0 (48 reviews)', address: 'Canterbury', badge: 'Request a free appraisal' }
      };
      const AGENT_KEYS = Object.keys(AGENTS);

      function buildHighlights(p, m) {
        if (m?.highlights?.length) return m.highlights.slice(0, 6);
        const out = [];
        if (p.type) out.push(`${p.type} with functional layout`);
        if (p.bedrooms > 0) out.push(`${p.bedrooms} bedroom${p.bedrooms > 1 ? 's' : ''}`);
        if (p.bathrooms > 0) out.push(`${p.bathrooms} bathroom${p.bathrooms > 1 ? 's' : ''}`);
        if (p.carspaces > 0) out.push(`${p.carspaces} car space${p.carspaces > 1 ? 's' : ''}`);
        if (p.suburb) out.push(`Convenient ${p.suburb} location`);
        out.push('Open-plan living/dining', 'Close to shops, schools & transport');
        return Array.from(new Set(out)).slice(0, 5);
      }

      function buildLongDesc(p, m) {
        if (m?.longDesc) return m.longDesc;
        return `
      ${s('Situated in', p.suburb ? `the heart of ${p.suburb},` : 'a convenient locale,')}
      this ${p.type || 'property'} offers a practical layout and light-filled interiors.
      Features include ${p.bedrooms || 0} bedroom${p.bedrooms > 1 ? 's' : ''},
      ${p.bathrooms || 0} bathroom${p.bathrooms > 1 ? 's' : ''}${p.carspaces ? ` and ${p.carspaces} car space${p.carspaces > 1 ? 's' : ''}` : ''}.
      With easy access to local amenities, this home suits buyers and investors alike.
    `;
      }

      function buildFeatures(p, m) {
        if (m?.features?.length) return m.features.slice(0, 12);
        const out = [];
        if (p.bedrooms) out.push(`Bedrooms: ${p.bedrooms}`);
        if (p.bathrooms) out.push(`Bathrooms: ${p.bathrooms}`);
        out.push(`Parking: ${p.carspaces || 0}`);
        if (p.type) out.push(`Property type: ${p.type}`);
        if (p.suburb) out.push(`Suburb: ${p.suburb}`);
        out.push('Built-in wardrobes', 'Open-plan living');
        return out;
      }

      function chooseAgent(p, m) {
        if (m?.agent && AGENTS[m.agent]) return m.agent;
        if (typeof p.id === 'number') return AGENT_KEYS[p.id % AGENT_KEYS.length];
        return pick(AGENT_KEYS);
      }

      function agentHTML(key, p) {
        const a = AGENTS[key];
        if (!a) return '';
        const suburb = p.suburb ? ` ‚Ä¢ ${p.suburb}` : '';
        return `
      <div class="agent-card">
        <div class="agent-card__header">
          <div class="avatar"></div>
          <div class="agent-card__text">
            <div class="agent-card__name">${a.name}</div>
            <div class="agent-card__rating">‚≠ê ${a.rating}</div>
            <div class="agent-card__agency">${a.agency}${suburb}</div>
            <div class="agent-card__addr">${a.address}</div>
          </div>
        </div>
        <div class="agent-actions">
          <a class="btn-primary-sm" href="/enquire.html?suburb=${encodeURIComponent(p.suburb || '')}">${a.badge}</a>
          <a class="btn-sm" href="/enquire.html?suburb=${encodeURIComponent(p.suburb || '')}">Get in touch</a>
        </div>
      </div>
    `;
      }

      function renderPropertyMeta(p) {
        console.log('[property-meta] rendering for id=', p?.id); // breadcrumb for you

        const m = MANUAL_META[p?.id];

        // Highlights
        const highlights = buildHighlights(p, m);
        const hlSec = $('prop-highlights'), hlList = $('prop-highlights-list');
        if (hlSec && hlList && highlights.length) {
          hlList.innerHTML = highlights.map(h => `<li>${h}</li>`).join('');
          hlSec.hidden = false;
        }

        // Long description with toggle
        const desc = buildLongDesc(p, m);
        const dSec = $('prop-longdesc'), dBody = $('prop-longdesc-body'), dToggle = $('prop-longdesc-toggle');
        if (dSec && dBody && desc) {
          dBody.innerHTML = `<p>${desc.replace(/\n+/g, '</p><p>')}</p>`;
          dSec.hidden = false;
          if (dToggle) {
            let open = false;
            dToggle.addEventListener('click', () => {
              open = !open;
              dBody.classList.toggle('clamp-6', !open);
              dToggle.textContent = open ? 'Read less' : 'Read more';
            });
          }
        }

        // Features
        const feats = buildFeatures(p, m);
        const fSec = $('prop-features'), fGrid = $('prop-features-grid');
        if (fSec && fGrid && feats.length) {
          fGrid.innerHTML = feats.map(f => `<div class="feature-pill">${f}</div>`).join('');
          fSec.hidden = false;
        }

        // Agent card
        const agentKey = chooseAgent(p, m);
        const aSec = $('prop-agent');
        if (aSec) {
          aSec.innerHTML = agentHTML(agentKey, p);
          aSec.hidden = false;
        }
      }

      // expose globally (your render(p) already calls this)
      window.renderPropertyMeta = renderPropertyMeta;
    })();

      // -------- Map & Directions (Leaflet + Nominatim) --------
      (function () {
        const mapEl = document.getElementById('news-map');
        if (!mapEl || !window.L) return;

        const sydney = [-33.8688, 151.2093];
        const map = L.map('news-map').setView(sydney, 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let originMarker = null;
        let destinationMarker = null;
        let propertyMarker = null;
        const bounds = L.latLngBounds([]);

        function setMarker(kind, lat, lon, label, state = null) {
          const latLng = L.latLng(lat, lon);
          
          // Create state-specific colored marker for property
          if (kind === 'property') {
            // Define state colors
            const stateColors = {
              'NSW': '#dc2626', // Red
              'VIC': '#2563eb', // Blue
              'QLD': '#059669', // Green
              'WA': '#7c3aed',  // Purple
              'SA': '#ea580c',  // Orange
              'ACT': '#0891b2', // Cyan
              'TAS': '#be123c', // Rose
              'NT': '#ca8a04'   // Yellow
            };
            
            const color = stateColors[state] || '#6b7280'; // Default gray
            const stateCode = state || 'Unknown';
            
            const stateIcon = L.divIcon({
              className: 'state-property-marker',
              html: `<div style="background-color: ${color}; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: white; text-shadow: 1px 1px 1px rgba(0,0,0,0.5);">${stateCode}</div>`,
              iconSize: [24, 24],
              iconAnchor: [12, 12]
            });
            
            if (propertyMarker) map.removeLayer(propertyMarker);
            propertyMarker = L.marker(latLng, { icon: stateIcon }).bindPopup(`${label || 'Property Location'}<br><strong>State: ${stateCode}</strong>`);
            propertyMarker.addTo(map).openPopup();
            
            // Center map on property
            map.setView(latLng, 15);
            return;
          }
          
          // Regular markers for origin/destination
          const icon = L.icon({
            iconUrl: kind === 'origin' ? 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png' : 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [0, -36],
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            shadowSize: [41, 41]
          });

          const marker = L.marker(latLng, { icon }).bindPopup(label || kind);
          marker.addTo(map).openPopup();

          if (kind === 'origin') {
            if (originMarker) map.removeLayer(originMarker);
            originMarker = marker;
          } else {
            if (destinationMarker) map.removeLayer(destinationMarker);
            destinationMarker = marker;
          }

          bounds.extend(latLng);
          if (bounds.isValid()) map.fitBounds(bounds.pad(0.25));
        }

        async function geocode(q) {
          const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`;
          const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
          if (!res.ok) throw new Error('Failed to geocode');
          const data = await res.json();
          return Array.isArray(data) && data[0] ? data[0] : null;
        }

        async function locate(kind, inputEl) {
          const q = (inputEl?.value || '').trim();
          if (!q) return;
          try {
            const hit = await geocode(q);
            if (!hit) { alert('Address not found'); return; }
            setMarker(kind, Number(hit.lat), Number(hit.lon), hit.display_name);
          } catch (e) {
            console.error(e);
            alert('Could not locate that address');
          }
        }

        // Function to load property location automatically
        async function loadPropertyLocation(property) {
          if (!property) return;
          
          // Build full address from property data
          const addressParts = [
            property.address,
            property.suburb,
            property.state,
            property.postcode
          ].filter(Boolean);
          
          const fullAddress = addressParts.join(', ');
          if (!fullAddress) return;

          try {
            const result = await geocode(fullAddress);
            if (result) {
              setMarker('property', Number(result.lat), Number(result.lon), fullAddress, property.state);
              // Set the destination input to the property address
              const destInput = document.getElementById('mapDestination');
              if (destInput) destInput.value = fullAddress;
            }
          } catch (e) {
            console.error('Failed to geocode property address:', e);
          }
        }

        const originInput = document.getElementById('mapOrigin');
        const destInput = document.getElementById('mapDestination');
        const locateBtn = document.getElementById('mapLocateDest');
        const dirBtn = document.getElementById('mapDirections');

        if (locateBtn) locateBtn.addEventListener('click', async () => {
          await locate('origin', originInput);
          await locate('destination', destInput);
        });

        if (dirBtn) dirBtn.addEventListener('click', () => {
          const origin = (originInput?.value || '').trim();
          const dest = (destInput?.value || '').trim();
          if (!dest) { alert('Enter destination'); return; }
          const url = new URL('https://www.google.com/maps/dir/');
          const params = new URLSearchParams({ api: '1' });
          if (origin) params.set('origin', origin);
          params.set('destination', dest);
          url.search = params.toString();
          window.open(url.toString(), '_blank');
        });

        // Initialize with Sydney CBD as destination example
        destInput && (destInput.value = 'Sydney CBD');
        
        // Expose function to load property data
        window.loadPropertyMap = loadPropertyLocation;
      })();

  </script>

</body>

</html>
