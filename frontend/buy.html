<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Buy Properties</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="/css/style.css" />
</head>

<body>
    <header class="nav-shell">
        <div class="nav-top">
            <button id="menuToggle" class="menu-btn" aria-expanded="false" aria-controls="navLinks">
                <span class="menu-icon"></span>
                <span class="menu-text">Menu</span>
            </button>

            <a href="index.html" class="brand">
                <img src="/Assets/Logo.png" alt="logo" style="height:40px" />
            </a>

            <div class="navbar-buttons" id="navbarUser">
                <a class="button-primary" href="signUp.html" style="text-decoration:none;color:#fff">Sign Up</a>
                <a class="button-primary" href="login.html" style="text-decoration:none;color:#fff">Login</a>
            </div>
        </div>

        <div id="navLinks" class="nav-links">
            <nav id="navbar" class="navbar-selector">
                <a href="buy.html">Buy</a>
                <a href="rent.html">Rent</a>
                <a href="sold.html">Sold</a>
                <a href="findAgent.html">Find Agent</a>
                <a href="news.html">News</a>
            </nav>
        </div>
    </header>

    <!-- Slim hero search strip -->
    <section class="prop-hero">
        <div class="prop-hero-inner">
            <div class="prop-search">
                <div class="search-input-wrap">
                    <svg class="search-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M10 18a8 8 0 1 1 5.293-14.003A8 8 0 0 1 10 18Zm11 3-6.001-6" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                    <input id="propQuery" class="agent-search-input"
                        placeholder="Search suburb or postcode (e.g., Zetland or 2017)" autocomplete="off" />
                </div>
                <button id="propGo" class="agent-search-btn">Search</button>
            </div>

            <div class="prop-chips">
                <button class="chip active">Buy</button>
                <button class="chip" onclick="location.href='rent.html'">Rent</button>
                <button class="chip" onclick="location.href='sold.html'">Sold</button>
            </div>
        </div>
    </section>

    <!-- Results -->
    <section class="agent-results-wrap">
        <div class="results-header">
            <div id="resultsPath" class="results-path">Buy properties</div>
            <div class="filters-row">
                <div class="chip dropdown-chip">
                    <label for="typeSel">Type</label>
                    <select id="typeSel">
                        <option value="">Any</option>
                        <option>House</option>
                        <option>Apartment</option>
                        <option>Townhouse</option>
                    </select>
                </div>
                <div class="chip dropdown-chip">
                    <label for="bedSel">Beds</label>
                    <select id="bedSel">
                        <option value="">Any</option>
                        <option>1</option>
                        <option>2</option>
                        <option>3</option>
                        <option>4</option>
                    </select>
                </div>
                <div class="chip dropdown-chip">
                    <label for="priceSel">Price</label>
                    <select id="priceSel">
                        <option value="">Any</option>
                        <option value="0-600000">Up to $600k</option>
                        <option value="600000-900000">$600k‚Äì$900k</option>
                        <option value="900000-1500000">$900k‚Äì$1.5M</option>
                        <option value="1500000-99999999">$1.5M+</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="propList" class="prop-grid"></div>
    </section>

    <div class="site-footer-spacer"></div>

    <script>
        /* Show user state */
        (function () {
            const navbarUser = document.getElementById("navbarUser");
            try {
                const user = JSON.parse(localStorage.getItem("user") || "null");
                if (!user) return;
                const displayName = user.first_name?.trim() || user.email;
                navbarUser.innerHTML = '<span style="margin-right:10px;color:#047857;font-weight:600;">Welcome, ' + displayName + '</span><button class="button-secondary" id="logoutBtn">Logout</button>';
                document.getElementById("logoutBtn").addEventListener("click", () => { localStorage.removeItem("user"); location.reload(); });
            } catch (_) { }
        })();
      //  -------- Auth area (creates dropdown for logged-in user) --------
(function () {
  const navbarUser = document.getElementById("navbarUser");
  try {
    const user = JSON.parse(localStorage.getItem("user") || "null");
    if (!user) return; // Exit if no user is logged in

    // Combine first name and last name for a full name display
    const firstName = user.first_name || "";
    const lastName = user.last_name || "";
    const displayName =
      `${firstName} ${lastName}`.trim() || user.email;

    // This new HTML structure includes the dropdown menu
    navbarUser.innerHTML = `
      <div style="display:flex; align-items:center; gap:16px; color:#047857; font-weight:600;">
        
        <!-- Dropdown container -->
        <div class="dropdown">
          
          <!-- This is the visible text that triggers the dropdown on hover -->
          <span style="cursor: pointer;">Welcome, ${escapeHtml(displayName)}</span>
          
          <!-- This is the hidden dropdown content -->
          <div class="dropdown-content">
            <a href="profile.html">My Profile</a>
            <a href="wishlist.html">My Wishlist</a>
          </div>

        </div>

        <button class="button-secondary" id="logoutBtn">Logout</button>
      </div>
    `;

    // The only event listener needed now is for the logout button
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("user");
      window.location.reload(); // Reload the page to reset the state
    });

  } catch (err) {
      console.error("Failed to initialize user navbar:", err);
  }
})();

        const $ = s => document.querySelector(s);
        const listEl = $('#propList');
        const pathEl = $('#resultsPath');
        const qEl = $('#propQuery');

        function params() {
            const u = new URL(location.href);
            return {
                q: (u.searchParams.get('q') || '').trim(),
                type: u.searchParams.get('type') || '',
                beds: u.searchParams.get('beds') || '',
                price: u.searchParams.get('price') || ''
            };
        }

        function setControls(p) {
            qEl.value = p.q || '';
            $('#typeSel').value = p.type || '';
            $('#bedSel').value = p.beds || '';
            $('#priceSel').value = p.price || '';
        }

        function inRange(price, range) {
            if (!range) return true;
            const [min, max] = range.split('-').map(Number);
            return price >= min && price <= max;
        }

        function money(n) {
            if (typeof n !== 'number') return '';
            return n.toLocaleString('en-AU', { style: 'currency', currency: 'AUD', maximumFractionDigits: 0 });
        }

        function card(p) {
            const label = money(Number(p.price || 0));
            const cover = p.image || '/Assets/placeholder.png';
            return `
        <article class="property-card" onclick="location.href='property.html?id=${p.id}&status=buy'" style="cursor:pointer">
          <div class="prop-photo-wrap">
            <img class="prop-photo" src="${cover}" alt="${p.address || ''}">
            <span class="prop-badge">${p.type || 'Property'}</span>
          </div>
          <div class="prop-body">
            <div class="prop-price">${label}</div>
            <div class="prop-address">${p.address || ''}</div>
            <div class="prop-sub">${p.suburb || ''}, ${p.state || ''} ${p.postcode || ''}</div>
            <div class="prop-meta">
              <span>üõè ${p.bedrooms ?? 0}</span>
              <span>üõÅ ${p.bathrooms ?? 0}</span>
              <span>üöó ${p.carspaces ?? 0}</span>
            </div>
            <div class="prop-actions">
              <button class="btn-primary-full">Enquire</button>
              <button class="btn-ghost-full">Save</button>
            </div>
          </div>
        </article>
      `;
        }

        //async function fetchListings(q) {
         //   const url = new URL('/api/listings', location.origin);
           // url.searchParams.set('status', 'buy');
           // if (q) url.searchParams.set('q', q);
           // const res = await fetch(url);
          //  if (!res.ok) throw new Error('Failed to load listings');
           // const data = await res.json();
           // return data.results || [];
        //}
        async function fetchListings(p) {
            const url = new URL('/api/listings', location.origin);
            url.searchParams.set('status', 'buy');
            if (p.q) url.searchParams.set('q', p.q);
            if (p.type) url.searchParams.set('type', p.type);
            if (p.beds) url.searchParams.set('minBeds', p.beds);
            url.searchParams.set('limit', '20');   // üëà force 20 properties
            url.searchParams.set('offset', '0');   // optional

            const res = await fetch(url);
            if (!res.ok) throw new Error('Failed to load listings');
            const data = await res.json();
            return data.results || [];
        }

        async function render() {
            const p = params();
            setControls(p);

            try {
                let data = await fetchListings(p.q);

                if (p.type) data = data.filter(x => (x.type || '') === p.type);
                if (p.beds) data = data.filter(x => (x.bedrooms || 0) >= Number(p.beds));
                if (p.price) data = data.filter(x => inRange(Number(x.price || 0), p.price));

                pathEl.textContent = `Buy properties${p.q ? ' in ' + p.q : ''} ‚Ä¢ ${data.length} found`;
                listEl.innerHTML = data.length ? data.map(card).join('') : '<p class="helper">No properties found. Try another suburb or clear filters.</p>';
            } catch (e) {
                console.error(e);
                listEl.innerHTML = '<p class="helper error">Could not load properties.</p>';
            }
        }

        function pushState() {
            const q = qEl.value.trim();
            const type = $('#typeSel').value;
            const beds = $('#bedSel').value;
            const price = $('#priceSel').value;

            const qs = new URLSearchParams({ q, type, beds, price });
            history.replaceState(null, '', '?' + qs.toString());
        }

        
        // events
        $('#propGo').addEventListener('click', () => { pushState(); render(); });
        qEl.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); pushState(); render(); } });
        $('#typeSel').addEventListener('change', () => { pushState(); render(); });
        $('#bedSel').addEventListener('change', () => { pushState(); render(); });
        $('#priceSel').addEventListener('change', () => { pushState(); render(); });

        // mobile menu toggle
        (function () {
            const shell = document.querySelector('.nav-shell');
            const btn = document.getElementById('menuToggle');
            if (btn && shell) btn.addEventListener('click', () => {
                const isOpen = shell.classList.toggle('open');
                btn.setAttribute('aria-expanded', String(isOpen));
            });
        })();

        
        render();
    </script>
</body>

<footer class="site-footer">
    <div class="footer-inner"></div>
</footer>

</html>